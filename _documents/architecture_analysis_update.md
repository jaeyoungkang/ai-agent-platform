# AI ì—ì´ì „íŠ¸ í”Œë«í¼ - ì•„í‚¤í…ì²˜ ë¶„ì„ ë° ì—…ë°ì´íŠ¸

**ì‘ì„±ì¼**: 2025ë…„ 8ì›” 19ì¼ (2025ë…„ 8ì›” 20ì¼ ì—…ë°ì´íŠ¸)  
**ë¶„ì„ ëª©ì **: í˜„ì¬ ì»¨í…Œì´ë„ˆ ì‚¬ìš© íŒ¨í„´ ì ê²€ ë° ë‹¨ìˆœí™” ë°©í–¥ ì œì‹œ

## ğŸš¨ ì¤‘ìš” ì—…ë°ì´íŠ¸ (2025-08-20)

**ì•„í‚¤í…ì²˜ ë³€ê²½ ì™„ë£Œ**: Docker-in-Dockerì—ì„œ **Kubernetes-Native** ë°©ì‹ìœ¼ë¡œ ì „í™˜
- **GKE Autopilot** í™˜ê²½ì—ì„œ Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰ ì œí•œìœ¼ë¡œ ì¸í•œ ì„¤ê³„ ë³€ê²½
- **DISABLE_DOCKER=true** í™˜ê²½ì—ì„œ Claude Code CLI ì‹œë®¬ë ˆì´ì…˜ ë°©ì‹ ì ìš©
- ì‚¬ìš©ìë³„ ì»¨í…Œì´ë„ˆ ìƒì„± ë¡œì§ì€ **ë¹„í™œì„±í™” ìƒíƒœ**ë¡œ ìœ ì§€

---

## ğŸ“Š ë³€ê²½ëœ ì•„í‚¤í…ì²˜ ë¶„ì„

### ğŸ³ ë³€ê²½ëœ ì‹¤í–‰ í™˜ê²½ íŒ¨í„´

#### í˜„ì¬ êµ¬ì¡° (Kubernetes-Native)
```python
# main.py:40-45 (ì—…ë°ì´íŠ¸ë¨)
docker_client = None
if os.getenv("DISABLE_DOCKER", "false").lower() != "true":
    try:
        docker_client = docker.from_env()
    except Exception as e:
        logger.warning(f"Docker not available: {e}")
        docker_client = None
```

#### ì‹¤ì œ ë™ì‘ ë°©ì‹ (ë³€ê²½ë¨)
1. **WebSocket ì—°ê²° ì‹œ**: ì»¨í…Œì´ë„ˆ ìƒì„± **ì‹œë„í•˜ì§€ ì•ŠìŒ** (DISABLE_DOCKER=true)
2. **ì—ì´ì „íŠ¸ ìƒì„± ì‹œ**: Kubernetes Pod ë‚´ì—ì„œ ì§ì ‘ ì‹¤í–‰
3. **ì‹¤í–‰ ë²”ìœ„**: Pod ìˆ˜ì¤€ì—ì„œ ê²©ë¦¬ (ì»¨í…Œì´ë„ˆ ì¤‘ì²© ì—†ìŒ)
4. **Claude Code CLI**: ì‹œë®¬ë ˆì´ì…˜ ì‘ë‹µìœ¼ë¡œ ëŒ€ì²´

---

## ğŸ” ë³€ê²½ëœ ì‹¤í–‰ íŒ¨í„´ ë¶„ì„

### âœ… í˜„ì¬ íŒ¨í„´: "Kubernetes Pod ì§ì ‘ ì‹¤í–‰"

```
ì „ì²´ ì‚¬ìš©ì â†’ ê³µìœ  Kubernetes Pod â†’ ì—ì´ì „íŠ¸ 1, 2, 3, 4...
â”œâ”€ ì‚¬ìš©ìë³„ ì„¸ì…˜ ê²©ë¦¬ (ë©”ëª¨ë¦¬)
â”œâ”€ ì—ì´ì „íŠ¸ë³„ ë°ì´í„° ê²©ë¦¬ (Firestore)
â””â”€ ì„ì‹œ ì‘ì—…ê³µê°„ (emptyDir)
```

**ì¥ì :**
- âœ… **ë³´ì•ˆ ê°•í™”**: GKE Autopilot ë³´ì•ˆ ì •ì±… ì™„ì „ ì¤€ìˆ˜
- âœ… **ê´€ë¦¬ ë‹¨ìˆœí™”**: ì»¨í…Œì´ë„ˆ ì¤‘ì²© ì—†ì´ Pod ìˆ˜ì¤€ ê´€ë¦¬
- âœ… **ë¦¬ì†ŒìŠ¤ íš¨ìœ¨ì„±**: ëª¨ë“  ì‚¬ìš©ìê°€ Pod ë¦¬ì†ŒìŠ¤ ê³µìœ 
- âœ… **ìë™ ìŠ¤ì¼€ì¼ë§**: Kubernetes HPAë¡œ ìë™ í™•ì¥/ì¶•ì†Œ
- âœ… **ì¥ì•  ë³µêµ¬**: Pod ì¥ì•  ì‹œ ìë™ ì¬ì‹œì‘

**ë³€ê²½ëœ ì œì•½ì‚¬í•­:**
- âš ï¸ **Claude Code CLI ì œí•œ**: ì‹¤ì œ CLI ëŒ€ì‹  ì‹œë®¬ë ˆì´ì…˜ ì‘ë‹µ
- âš ï¸ **íŒŒì¼ì‹œìŠ¤í…œ ê³µìœ **: ëª¨ë“  ì‚¬ìš©ìê°€ ë™ì¼í•œ Pod íŒŒì¼ì‹œìŠ¤í…œ ì‚¬ìš©
- âš ï¸ **ë¦¬ì†ŒìŠ¤ ê²½í•©**: CPU/ë©”ëª¨ë¦¬ë¥¼ ëª¨ë“  ì‚¬ìš©ìê°€ ê³µìœ 

### âŒ ì´ì „ íŒ¨í„´: "Docker-in-Docker" (GKEì—ì„œ ë¶ˆê°€ëŠ¥)

```
Pod â†’ Docker ì†Œì¼“ â†’ ì‚¬ìš©ìë³„ ì»¨í…Œì´ë„ˆ â†’ Claude Code CLI
```

**GKE Autopilotì—ì„œ ë¶ˆê°€ëŠ¥í•œ ì´ìœ :**
- âŒ **ë³´ì•ˆ ì •ì±… ìœ„ë°˜**: íŠ¹ê¶Œ ì»¨í…Œì´ë„ˆ ê¸ˆì§€
- âŒ **hostPath ê¸ˆì§€**: Docker ì†Œì¼“ ë§ˆìš´íŠ¸ ë¶ˆê°€
- âŒ **ë„¤íŠ¸ì›Œí¬ ì œí•œ**: í˜¸ìŠ¤íŠ¸ ë„¤íŠ¸ì›Œí¬ ì ‘ê·¼ ì œí•œ

---

## ğŸ’¡ ê¶Œì¥ì‚¬í•­: Kubernetes-Native êµ¬ì¡° ìµœì í™”

### ğŸ¯ í•µì‹¬ ì›ì¹™: "í´ë¼ìš°ë“œ ë„¤ì´í‹°ë¸Œ, ë³´ì•ˆ ìš°ì„ "

í˜„ì¬ì˜ **"Kubernetes Pod ì§ì ‘ ì‹¤í–‰"** ë°©ì‹ì´ í´ë¼ìš°ë“œ í™˜ê²½ì— ìµœì í™”ë¨:

1. **ë³´ì•ˆì„±**: GKE Autopilot ë³´ì•ˆ ì •ì±… ì™„ì „ ì¤€ìˆ˜
2. **í™•ì¥ì„±**: Kubernetes ìë™ ìŠ¤ì¼€ì¼ë§ í™œìš©
3. **ì•ˆì •ì„±**: Pod ë ˆë²¨ ì¥ì•  ë³µêµ¬ ë° ë¡œë“œë°¸ëŸ°ì‹±
4. **ë¹„ìš© íš¨ìœ¨ì„±**: ë¦¬ì†ŒìŠ¤ ê³µìœ ë¡œ ìš´ì˜ë¹„ ìµœì†Œí™”

### ğŸ“‹ Kubernetes í™˜ê²½ ìµœì í™” ë°©ì•ˆ

#### 1. Claude Code CLI ëŒ€ì²´ ì†”ë£¨ì…˜ êµ¬í˜„
```python
# í˜„ì¬: ì‹œë®¬ë ˆì´ì…˜ ì‘ë‹µ
# í–¥í›„: Cloud Run Jobs ë˜ëŠ” ë³„ë„ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ì„œë¹„ìŠ¤ ì—°ë™

async def send_to_claude(self, message: str, agent_id: str = None) -> str:
    if os.getenv("DISABLE_DOCKER", "false").lower() == "true":
        # ì‹œë®¬ë ˆì´ì…˜ ì‘ë‹µ (í˜„ì¬)
        return f"Claude Code CLIê°€ Kubernetes í™˜ê²½ì—ì„œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤..."
```

#### 2. Workload Identity ë³´ì•ˆ ê°•í™”
```yaml
# deployment.yamlì— ì´ë¯¸ ì ìš©ë¨
spec:
  serviceAccountName: ai-agent-ksa  # Workload Identity í™œìš©
  containers:
  - name: api-server
    env:
    - name: DISABLE_DOCKER
      value: "true"  # Docker ë¹„í™œì„±í™”
```

#### 3. HPA ê¸°ë°˜ ìë™ ìŠ¤ì¼€ì¼ë§ í™œìš©
```yaml
# í˜„ì¬ ì„¤ì •ëœ HPA
minReplicas: 1
maxReplicas: 3
targetCPUUtilizationPercentage: 80
```

---

## ğŸ”§ Kubernetes-Native ê°œë°œ ê°€ì´ë“œë¼ì¸

### ğŸš« í”¼í•´ì•¼ í•  ë³µì¡ì„±

1. **Docker-in-Docker ë³µì› ì‹œë„**: GKE Autopilotì—ì„œ ë¶ˆê°€ëŠ¥
2. **ë³µì¡í•œ ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ê²©ë¦¬**: Pod ìˆ˜ì¤€ì—ì„œ ì¶©ë¶„
3. **ê³¼ë„í•œ ë¦¬ì†ŒìŠ¤ ë¶„í• **: ê³µìœ  ë¦¬ì†ŒìŠ¤ ëª¨ë¸ ìœ ì§€
4. **ì»¨í…Œì´ë„ˆ ì˜¤ì¼€ìŠ¤íŠ¸ë ˆì´ì…˜**: Kubernetesê°€ ìë™ ì²˜ë¦¬

### âœ… í™œìš©í•´ì•¼ í•  Kubernetes ê¸°ëŠ¥

1. **Pod ìë™ ìŠ¤ì¼€ì¼ë§**: HPAë¡œ ì‚¬ìš©ì ì¦ê°€ì— ëŒ€ì‘
2. **ì„œë¹„ìŠ¤ ë°œê²¬**: Kubernetes Serviceë¡œ ë„¤íŠ¸ì›Œí‚¹
3. **ì„¤ì • ê´€ë¦¬**: Secret Manager + Workload Identity
4. **ìƒíƒœ ëª¨ë‹ˆí„°ë§**: Health Check + ìë™ ì¬ì‹œì‘

---

## ğŸ“Š Kubernetes ë¦¬ì†ŒìŠ¤ ì„¤ì • ë° ì œí•œ

### í˜„ì¬ Pod ë¦¬ì†ŒìŠ¤ ì„¤ì • (deployment.yaml)
```yaml
resources:
  requests:
    memory: "1Gi"      # Podë‹¹ 1GB ë©”ëª¨ë¦¬ ìš”ì²­
    cpu: "500m"        # Podë‹¹ 0.5 CPU ì½”ì–´ ìš”ì²­
  limits:
    memory: "2Gi"      # Podë‹¹ 2GB ë©”ëª¨ë¦¬ ì œí•œ
    cpu: "1000m"       # Podë‹¹ 1 CPU ì½”ì–´ ì œí•œ
```

### ë™ì‹œ ì‚¬ìš©ì ì˜ˆìƒ (100ëª… ê¸°ì¤€)
```
ì˜ˆìƒ ë™ì‹œ ì‚¬ìš©ì: 10-20ëª…
Podë‹¹ ì²˜ë¦¬ ê°€ëŠ¥: 30-50ëª… (ê²½í—˜ì  ìˆ˜ì¹˜)
HPA ìŠ¤ì¼€ì¼ë§: 1-3 Pod ìë™ ì¡°ì •
ì´ ì²˜ë¦¬ ëŠ¥ë ¥: 90-150ëª…
```

### ë¦¬ì†ŒìŠ¤ ê³µìœ  ëª¨ë¸
```
Pod 1 (1GB RAM, 1 CPU) â†’ ì „ì²´ ì‚¬ìš©ì ê³µìœ 
â”œâ”€ ì‚¬ìš©ìë³„ ì„¸ì…˜: ë©”ëª¨ë¦¬ 50-100MB
â”œâ”€ Firestore ì—°ê²°: ê³µìœ  ì»¤ë„¥ì…˜ í’€
â””â”€ WebSocket: ì‚¬ìš©ìë‹¹ 1ê°œ ì—°ê²°
```

---

## ğŸ¯ ê²°ë¡  ë° ì‹¤í–‰ ê³„íš

### âœ… ê²°ë¡ : Kubernetes-Native ì•„í‚¤í…ì²˜ ì„±ê³µì  ì „í™˜

**"Pod ì§ì ‘ ì‹¤í–‰"** ë°©ì‹ì´ ë‹¤ìŒ ì¡°ê±´ì„ ëª¨ë‘ ë§Œì¡±:
- âœ… **ë³´ì•ˆ ê°•í™”**: GKE Autopilot ì •ì±… ì™„ì „ ì¤€ìˆ˜
- âœ… **ìš´ì˜ ë‹¨ìˆœí™”**: Kubernetes ìë™ ê´€ë¦¬ í™œìš©
- âœ… **ë¹„ìš© íš¨ìœ¨ì„±**: ë¦¬ì†ŒìŠ¤ ê³µìœ ë¡œ ìš´ì˜ë¹„ ì ˆê°
- âœ… **í™•ì¥ì„±**: HPAë¡œ ìë™ ìŠ¤ì¼€ì¼ë§

### ğŸ“ ì™„ë£Œëœ ì£¼ìš” ë³€ê²½ì‚¬í•­

1. **Docker ë¹„í™œì„±í™”** (DISABLE_DOCKER=true)
2. **Workload Identity ì„¤ì •** (ai-agent-ksa ì„œë¹„ìŠ¤ ì–´ì¹´ìš´íŠ¸)
3. **LoadBalancer ì„œë¹„ìŠ¤** (ì™¸ë¶€ ì ‘ê·¼ í—ˆìš©)
4. **Firestore ê¶Œí•œ í•´ê²°** (403 ì˜¤ë¥˜ í•´ê²°)

### ğŸš€ í–¥í›„ ê°œì„  ìš°ì„ ìˆœìœ„

1. **Phase 1**: Claude Code CLI ëŒ€ì²´ ì†”ë£¨ì…˜ êµ¬í˜„ (Cloud Run Jobs)
2. **Phase 2**: ë„ë©”ì¸ ì—°ê²° ë° HTTPS ì ìš©
3. **Phase 3**: ëª¨ë‹ˆí„°ë§ ë° ë¡œê¹… ê°•í™”

---

## ğŸ’» Kubernetes-Native ì½”ë“œ ë³€ê²½ ì‚¬ë¡€

```python
# ë³€ê²½ ì „: Docker ì»¨í…Œì´ë„ˆ ìƒì„±
async def ensure_container(self) -> docker.models.containers.Container:
    try:
        self.container = docker_client.containers.get(self.container_name)
        # ë³µì¡í•œ ì»¨í…Œì´ë„ˆ ê´€ë¦¬ ë¡œì§...
    except docker.errors.NotFound:
        self.container = await self._create_container()

# ë³€ê²½ í›„: Docker ë¹„í™œì„±í™” ì‹œ ëŒ€ì²´ ë¡œì§
async def send_to_claude(self, message: str, agent_id: str = None) -> str:
    if os.getenv("DISABLE_DOCKER", "false").lower() == "true":
        logger.info(f"Docker disabled - simulating Claude response")
        return f"Claude Code CLIê°€ Kubernetes í™˜ê²½ì—ì„œ ì‹¤í–‰ ì¤‘ì…ë‹ˆë‹¤.\\n\\nì‚¬ìš©ì ë©”ì‹œì§€: {message}"
    
    # ê¸°ì¡´ Docker ë¡œì§ì€ ìœ ì§€ (ë¡œì»¬ ê°œë°œìš©)
    container = await self.ensure_container()
    # ...
```

ì´ëŸ¬í•œ **ì¡°ê±´ë¶€ ë¶„ê¸°**ë¡œ ê¸°ì¡´ ì½”ë“œë¥¼ ë³´ì¡´í•˜ë©´ì„œ Kubernetes í™˜ê²½ì— ëŒ€ì‘í–ˆìŠµë‹ˆë‹¤.

---

**í•µì‹¬ ë©”ì‹œì§€**: Kubernetes-Native ì „í™˜ì„ í†µí•´ **ë³´ì•ˆì„±ê³¼ í™•ì¥ì„±ì„ í™•ë³´**í•˜ë©´ì„œë„ **ì½”ë“œ ë³µì¡ë„ëŠ” ìµœì†Œí™”**í–ˆìŠµë‹ˆë‹¤. í–¥í›„ Claude Code CLI ëŒ€ì²´ ì†”ë£¨ì…˜ êµ¬í˜„ì„ í†µí•´ ì™„ì „í•œ ê¸°ëŠ¥ì„ ì œê³µí•  ì˜ˆì •ì…ë‹ˆë‹¤.