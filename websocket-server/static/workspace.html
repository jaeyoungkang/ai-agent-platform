<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 에이전트 플랫폼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="/assets/styles.css">
    <script src="/assets/common.js"></script>
    <style>
        /* 워크스페이스 특화 스타일 */
        .chat-container {
            scrollbar-width: thin;
            scrollbar-color: #c1c5c9 #f1f3f4;
        }
        
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }
        .chat-container::-webkit-scrollbar-track {
            background: #f1f3f4;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background: #c1c5c9;
            border-radius: 3px;
        }
        .chat-container::-webkit-scrollbar-thumb:hover {
            background: #a8acb1;
        }
        
        /* 메시지 스타일 */
        .message-user {
            background: #4b5563;
            color: white;
        }
        
        .message-claude {
            background: #2563eb;
            color: white;
        }
        
        .message-system {
            background: #6b7280;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="header-gradient shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3">
                    <div class="header-logo">
                        <span class="text-gray-700 font-semibold text-sm">AI</span>
                    </div>
                    <h1 class="text-lg font-medium text-white">워크스페이스</h1>
                    <div class="text-sm text-gray-200">
                        <span id="agent-name">에이전트</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Connection Status -->
                    <div id="connection-status" class="flex items-center space-x-2">
                        <div id="status-indicator" class="w-2 h-2 bg-red-400 rounded-full"></div>
                        <span id="status-text" class="text-sm text-gray-200">연결 중</span>
                    </div>
                    <!-- User ID -->
                    <div class="text-sm text-gray-200">
                        ID: <span id="user-id" class="font-mono text-white">-</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden h-[calc(100vh-200px)]">
            
            <!-- Chat Area -->
            <div class="flex flex-col h-full">
                
                <!-- Chat Messages -->
                <div id="chat-area" class="flex-1 overflow-y-auto p-6 space-y-4 chat-container">
                    <!-- Welcome Message -->
                    <div class="flex justify-center">
                        <div class="bg-gray-50 border border-gray-300 rounded p-4 max-w-md text-center">
                            <h3 class="text-base font-medium text-gray-700 mb-2">워크스페이스 시작</h3>
                            <p class="text-sm text-gray-600">
                                Claude Code CLI와 상호작용하여 에이전트를 개발하세요.
                                <br><span class="text-xs text-gray-500">예: "데이터 분석 스크립트를 작성해주세요"</span>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="border-t bg-gray-50 p-4">
                    <div class="flex space-x-3">
                        <div class="flex-1">
                            <input 
                                type="text" 
                                id="message-input" 
                                placeholder="Claude에게 메시지를 입력하세요..."
                                class="form-input"
                                autocomplete="off"
                            >
                        </div>
                        <button 
                            id="send-button"
                            class="btn btn-primary"
                        >
                            전송
                        </button>
                    </div>
                    
                    <!-- Status Bar -->
                    <div id="status-bar" class="mt-3 text-sm text-gray-500 hidden">
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-blue-500 rounded-full status-pulse"></div>
                            <span id="status-message">처리 중...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        class AIAgentWorkspace {
            constructor() {
                this.websocket = null;
                this.sessionId = null;
                this.userId = null;
                this.agentId = null;
                this.isConnected = false;
                
                this.initializeElements();
                this.parseUrlParams();
                this.initializeWorkspace();
                this.setupEventListeners();
            }
            
            // localStorage에서 사용자 정보 가져오기
            getStoredUser() {
                try {
                    const userStr = localStorage.getItem('user');
                    return userStr ? JSON.parse(userStr) : null;
                } catch (e) {
                    console.warn('Failed to parse stored user data:', e);
                    return null;
                }
            }
            
            parseUrlParams() {
                const urlParams = new URLSearchParams(window.location.search);
                this.sessionId = urlParams.get('session');
                
                if (!this.sessionId) {
                    Notification.error('세션 ID가 필요합니다. 대시보드에서 접근해주세요.');
                    window.location.href = '/assets/dashboard.html';
                    return;
                }
            }
            
            async initializeWorkspace() {
                try {
                    // 1. 먼저 localStorage에서 인증된 사용자 정보 확인
                    const authenticatedUser = this.getStoredUser();
                    if (authenticatedUser) {
                        console.log('Found authenticated user in localStorage:', authenticatedUser);
                        this.userId = authenticatedUser.user_id;
                        document.getElementById('user-id').textContent = this.userId;
                    }
                    
                    // 2. 워크스페이스 상태 복원 시도
                    const workspace = await API.get(`/api/workspace/${this.sessionId}/restore`);
                    
                    if (workspace) {
                        // 인증된 사용자가 있으면 우선 사용, 없으면 워크스페이스 사용자 사용
                        if (!this.userId) {
                            this.userId = workspace.userId;
                            document.getElementById('user-id').textContent = this.userId;
                        }
                        
                        this.agentId = workspace.agentId;
                        this.context = workspace.context || 'workspace';  // 컨텍스트 설정
                        
                        // 대화 기록 복원
                        if (workspace.messages && workspace.messages.length > 0) {
                            this.restoreConversationHistory(workspace.messages);
                        }
                        
                        // 컨텍스트에 따른 UI 초기화
                        if (this.context === 'agent-create') {
                            this.initAgentCreationMode();
                        } else {
                            // 기존 에이전트 정보 로드
                            await this.loadAgentInfo();
                        }
                        
                        // WebSocket 연결
                        this.connectWebSocket();
                    } else {
                        throw new Error('Failed to restore workspace');
                    }
                } catch (error) {
                    console.error('Workspace initialization failed:', error);
                    this.updateConnectionStatus('error', '워크스페이스 오류');
                    
                    // 인증된 사용자가 있으면 바로 연결, 없으면 로그인 페이지로 이동
                    if (this.userId) {
                        console.log('Using authenticated user for fallback connection');
                        this.connectWebSocket();
                    } else {
                        console.log('No authenticated user found, redirecting to login');
                        alert('로그인이 필요합니다. 로그인 페이지로 이동합니다.');
                        window.location.href = '/assets/index.html';
                    }
                }
            }
            
            redirectToLogin() {
                console.log('Authentication required, redirecting to login page');
                alert('로그인이 필요합니다. 로그인 페이지로 이동합니다.');
                window.location.href = '/assets/index.html';
            }
            
            async loadAgentInfo() {
                if (!this.agentId) return;
                
                try {
                    const agent = await API.get(`/api/agents/${this.agentId}`, {
                        'X-User-Id': this.userId
                    });
                    
                    if (agent) {
                        document.getElementById('agent-name').textContent = agent.name;
                        document.getElementById('user-id').textContent = this.userId;
                    }
                } catch (error) {
                    console.error('Failed to load agent info:', error);
                }
            }
            
            initializeElements() {
                this.chatArea = document.getElementById('chat-area');
                this.messageInput = document.getElementById('message-input');
                this.sendButton = document.getElementById('send-button');
                this.statusIndicator = document.getElementById('status-indicator');
                this.statusText = document.getElementById('status-text');
                this.statusBar = document.getElementById('status-bar');
                this.statusMessage = document.getElementById('status-message');
            }
            
            connectWebSocket() {
                if (!this.userId) {
                    console.error('Cannot connect WebSocket: No user ID');
                    return;
                }
                
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/workspace/${this.userId}`;
                
                console.log('Attempting WebSocket connection to:', wsUrl);
                this.websocket = new WebSocket(wsUrl);
                
                this.websocket.onopen = (event) => {
                    this.isConnected = true;
                    this.updateConnectionStatus('connected', '연결됨');
                    console.log('WebSocket connected');
                };
                
                this.websocket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        this.handleMessage(data);
                    } catch (error) {
                        console.error('WebSocket message parsing error:', error);
                        console.error('Raw message data:', event.data);
                    }
                };
                
                this.websocket.onclose = (event) => {
                    this.isConnected = false;
                    this.updateConnectionStatus('disconnected', '연결 끊김');
                    console.log('WebSocket disconnected');
                    console.log('Close code:', event.code, 'Reason:', event.reason, 'Clean:', event.wasClean);
                    
                    // Auto reconnect after 3 seconds
                    setTimeout(() => this.connectWebSocket(), 3000);
                };
                
                this.websocket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    this.updateConnectionStatus('error', '연결 오류');
                };
            }
            
            updateConnectionStatus(status, text) {
                const colors = {
                    connected: 'bg-green-400',
                    disconnected: 'bg-red-400',
                    error: 'bg-yellow-400'
                };
                
                this.statusIndicator.className = `w-2 h-2 rounded-full ${colors[status]}`;
                this.statusText.textContent = text;
            }
            
            setupEventListeners() {
                this.sendButton.addEventListener('click', () => this.sendMessage());
                
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
            }
            
            sendMessage() {
                const message = this.messageInput.value.trim();
                if (!message || !this.isConnected) return;
                
                // Display user message
                this.displayMessage('user', message);
                
                // Clear input
                this.messageInput.value = '';
                
                // Show processing status
                this.showStatus('메시지 처리 중...');
                
                // Send to WebSocket (세션 ID 포함)
                this.websocket.send(JSON.stringify({
                    message: message,
                    session_id: this.sessionId  // 세션 ID 전달
                }));
            }
            
            handleMessage(data) {
                console.log('Received message:', data);
                
                try {
                    switch (data.type) {
                        case 'system':
                            this.displayMessage('system', data.content);
                            break;
                        case 'claude_response':
                            this.displayMessage('claude', data.content);
                            this.hideStatus();
                            break;
                        default:
                            console.warn('Unknown message type:', data.type);
                    }
                } catch (error) {
                    console.error('Error handling message:', error);
                    console.error('Message data:', data);
                }
            }
            
            displayMessage(role, content, timestamp = null) {
                try {
                    const messageDiv = document.createElement('div');
                    messageDiv.className = 'flex mb-4';
                    
                    // timestamp가 있으면 사용, 없으면 현재 시간
                    const messageTime = timestamp ? new Date(timestamp.seconds * 1000) : new Date();
                    
                    if (role === 'user') {
                        messageDiv.innerHTML = `
                            <div class="flex-1"></div>
                            <div class="max-w-md">
                                <div class="message-user text-white rounded-lg px-4 py-3 shadow-md">
                                    <p class="text-sm font-medium mb-1">사용자</p>
                                    <p class="whitespace-pre-wrap">${this.escapeHtml(content)}</p>
                                </div>
                                <p class="text-xs text-gray-500 mt-1 text-right">${this.formatTime(messageTime)}</p>
                            </div>
                        `;
                    } else if (role === 'claude' || role === 'assistant') {
                        messageDiv.innerHTML = `
                            <div class="max-w-3xl">
                                <div class="message-claude text-white rounded-lg px-4 py-3 shadow-md">
                                    <p class="text-sm font-medium mb-1">Claude</p>
                                    <div class="whitespace-pre-wrap">${this.formatClaudeResponse(content)}</div>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">${this.formatTime(messageTime)}</p>
                            </div>
                            <div class="flex-1"></div>
                        `;
                    } else if (role === 'system') {
                        messageDiv.innerHTML = `
                            <div class="w-full">
                                <div class="message-system text-white rounded-lg px-4 py-3 shadow-md text-center max-w-md mx-auto">
                                    <p class="text-sm">${this.escapeHtml(content)}</p>
                                </div>
                            </div>
                        `;
                    }
                    
                    this.chatArea.appendChild(messageDiv);
                    this.scrollToBottom();
                } catch (error) {
                    console.error('Error displaying message:', error);
                    console.error('Role:', role, 'Content:', content);
                }
            }
            
            formatClaudeResponse(content) {
                // Simple formatting for Claude's response
                return this.escapeHtml(content)
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/`(.*?)`/g, '<code class="bg-white bg-opacity-20 px-1 rounded">$1</code>');
            }
            
            escapeHtml(text) {
                try {
                    return Utils.escapeHtml(text);
                } catch (error) {
                    console.error('Error escaping HTML:', error);
                    // Fallback to basic HTML escaping
                    return String(text)
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#39;');
                }
            }
            
            formatTime(date) {
                try {
                    return Utils.formatTime(date);
                } catch (error) {
                    console.error('Error formatting time:', error);
                    // Fallback to basic time formatting
                    return date.toLocaleTimeString();
                }
            }
            
            showStatus(message) {
                this.statusMessage.textContent = message;
                this.statusBar.classList.remove('hidden');
            }
            
            hideStatus() {
                this.statusBar.classList.add('hidden');
            }
            
            scrollToBottom() {
                this.chatArea.scrollTop = this.chatArea.scrollHeight;
            }
            
            restoreConversationHistory(messages) {
                console.log(`Restoring ${messages.length} messages from conversation history`);
                
                // 기존 환영 메시지 제거
                const welcomeMessage = this.chatArea.querySelector('div:first-child');
                if (welcomeMessage && welcomeMessage.innerHTML.includes('워크스페이스 시작')) {
                    welcomeMessage.remove();
                }
                
                // 메시지들을 순서대로 표시
                messages.forEach(message => {
                    try {
                        this.displayMessage(message.role, message.content, message.timestamp);
                    } catch (error) {
                        console.error('Error restoring message:', error, message);
                    }
                });
                
                // 스크롤을 맨 아래로 이동
                this.scrollToBottom();
            }
            
            initAgentCreationMode() {
                // 에이전트 생성 모드 UI 초기화
                console.log('Initializing agent creation mode');
                
                // 헤더 업데이트
                const agentName = document.getElementById('agent-name');
                if (agentName) {
                    agentName.textContent = '새 에이전트 생성';
                }
                
                // 대화 기록이 없을 때만 환영 메시지 추가
                if (this.chatArea.children.length <= 1) {
                    this.displayMessage('system', '안녕하세요! AI 에이전트를 만들어드릴게요. 어떤 작업을 자동화하고 싶으신가요?');
                }
                
                // 사용자 ID 표시
                const userIdElement = document.getElementById('user-id');
                if (userIdElement && this.userId) {
                    userIdElement.textContent = this.userId;
                }
            }
        }
        
        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new AIAgentWorkspace();
        });
    </script>
</body>
</html>