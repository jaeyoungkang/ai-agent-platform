<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 에이전트 플랫폼</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="styles.css">
    <script src="common.js"></script>
    <style>
        /* 워크스페이스 특화 스타일 */
        .chat-container {
            scrollbar-width: thin;
            scrollbar-color: #c1c5c9 #f1f3f4;
        }
        
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }
        .chat-container::-webkit-scrollbar-track {
            background: #f1f3f4;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background: #c1c5c9;
            border-radius: 3px;
        }
        .chat-container::-webkit-scrollbar-thumb:hover {
            background: #a8acb1;
        }
        
        /* 메시지 스타일 */
        .message-user {
            background: #4b5563;
            color: white;
        }
        
        .message-claude {
            background: #2563eb;
            color: white;
        }
        
        .message-system {
            background: #6b7280;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Header -->
    <header class="header-gradient shadow-sm">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center py-4">
                <div class="flex items-center space-x-3">
                    <div class="header-logo">
                        <span class="text-gray-700 font-semibold text-sm">AI</span>
                    </div>
                    <h1 class="text-lg font-medium text-white">워크스페이스</h1>
                    <div class="text-sm text-gray-200">
                        <span id="agent-name">에이전트</span>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <!-- Connection Status -->
                    <div id="connection-status" class="flex items-center space-x-2">
                        <div id="status-indicator" class="w-2 h-2 bg-red-400 rounded-full"></div>
                        <span id="status-text" class="text-sm text-gray-200">연결 중</span>
                    </div>
                    <!-- User ID -->
                    <div class="text-sm text-gray-200">
                        ID: <span id="user-id" class="font-mono text-white">-</span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="bg-white rounded-xl shadow-lg overflow-hidden h-[calc(100vh-200px)]">
            
            <!-- Chat Area -->
            <div class="flex flex-col h-full">
                
                <!-- Chat Messages -->
                <div id="chat-area" class="flex-1 overflow-y-auto p-6 space-y-4 chat-container">
                    <!-- Welcome Message -->
                    <div class="flex justify-center">
                        <div class="bg-gray-50 border border-gray-300 rounded p-4 max-w-md text-center">
                            <h3 class="text-base font-medium text-gray-700 mb-2">워크스페이스 시작</h3>
                            <p class="text-sm text-gray-600">
                                Claude Code CLI와 상호작용하여 에이전트를 개발하세요.
                                <br><span class="text-xs text-gray-500">예: "데이터 분석 스크립트를 작성해주세요"</span>
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Input Area -->
                <div class="border-t bg-gray-50 p-4">
                    <div class="flex space-x-3">
                        <div class="flex-1">
                            <input 
                                type="text" 
                                id="message-input" 
                                placeholder="Claude에게 메시지를 입력하세요..."
                                class="form-input"
                                autocomplete="off"
                            >
                        </div>
                        <button 
                            id="send-button"
                            class="btn btn-primary"
                        >
                            전송
                        </button>
                    </div>
                    
                    <!-- Status Bar -->
                    <div id="status-bar" class="mt-3 text-sm text-gray-500 hidden">
                        <div class="flex items-center space-x-2">
                            <div class="w-2 h-2 bg-blue-500 rounded-full status-pulse"></div>
                            <span id="status-message">처리 중...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        class AIAgentWorkspace {
            constructor() {
                this.websocket = null;
                this.sessionId = null;
                this.userId = null;
                this.agentId = null;
                this.isConnected = false;
                
                this.initializeElements();
                this.parseUrlParams();
                this.initializeWorkspace();
                this.setupEventListeners();
            }
            
            parseUrlParams() {
                const urlParams = new URLSearchParams(window.location.search);
                this.sessionId = urlParams.get('session');
                
                if (!this.sessionId) {
                    Notification.error('세션 ID가 필요합니다. 대시보드에서 접근해주세요.');
                    window.location.href = '/static/dashboard.html';
                    return;
                }
            }
            
            async initializeWorkspace() {
                try {
                    // 워크스페이스 상태 복원
                    const workspace = await API.get(`/api/workspace/${this.sessionId}/restore`);
                    
                    if (workspace) {
                        this.userId = workspace.userId;
                        this.agentId = workspace.agentId;
                        
                        // 에이전트 정보 로드
                        await this.loadAgentInfo();
                        
                        // WebSocket 연결
                        this.connectWebSocket();
                    } else {
                        throw new Error('Failed to restore workspace');
                    }
                } catch (error) {
                    console.error('Workspace initialization failed:', error);
                    this.updateConnectionStatus('error', '워크스페이스 오류');
                    
                    // 인증 후 WebSocket 연결 (fallback)
                    await this.fallbackAuth();
                }
            }
            
            async fallbackAuth() {
                try {
                    const authData = await API.post('/api/auth/guest', {});
                    
                    if (authData) {
                        this.userId = authData.user_id;
                        document.getElementById('user-id').textContent = this.userId;
                        this.connectWebSocket();
                    }
                } catch (error) {
                    console.error('Fallback auth failed:', error);
                }
            }
            
            async loadAgentInfo() {
                if (!this.agentId) return;
                
                try {
                    const agent = await API.get(`/api/agents/${this.agentId}`, {
                        'X-User-Id': this.userId
                    });
                    
                    if (agent) {
                        document.getElementById('agent-name').textContent = agent.name;
                        document.getElementById('user-id').textContent = this.userId;
                    }
                } catch (error) {
                    console.error('Failed to load agent info:', error);
                }
            }
            
            initializeElements() {
                this.chatArea = document.getElementById('chat-area');
                this.messageInput = document.getElementById('message-input');
                this.sendButton = document.getElementById('send-button');
                this.statusIndicator = document.getElementById('status-indicator');
                this.statusText = document.getElementById('status-text');
                this.statusBar = document.getElementById('status-bar');
                this.statusMessage = document.getElementById('status-message');
            }
            
            connectWebSocket() {
                if (!this.userId) {
                    console.error('Cannot connect WebSocket: No user ID');
                    return;
                }
                
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/workspace/${this.userId}`;
                
                this.websocket = new WebSocket(wsUrl);
                
                this.websocket.onopen = (event) => {
                    this.isConnected = true;
                    this.updateConnectionStatus('connected', '연결됨');
                    console.log('WebSocket connected');
                };
                
                this.websocket.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    this.handleMessage(data);
                };
                
                this.websocket.onclose = (event) => {
                    this.isConnected = false;
                    this.updateConnectionStatus('disconnected', '연결 끊김');
                    console.log('WebSocket disconnected');
                    
                    // Auto reconnect after 3 seconds
                    setTimeout(() => this.connectWebSocket(), 3000);
                };
                
                this.websocket.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    this.updateConnectionStatus('error', '연결 오류');
                };
            }
            
            updateConnectionStatus(status, text) {
                const colors = {
                    connected: 'bg-green-400',
                    disconnected: 'bg-red-400',
                    error: 'bg-yellow-400'
                };
                
                this.statusIndicator.className = `w-2 h-2 rounded-full ${colors[status]}`;
                this.statusText.textContent = text;
            }
            
            setupEventListeners() {
                this.sendButton.addEventListener('click', () => this.sendMessage());
                
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });
            }
            
            sendMessage() {
                const message = this.messageInput.value.trim();
                if (!message || !this.isConnected) return;
                
                // Display user message
                this.displayMessage('user', message);
                
                // Clear input
                this.messageInput.value = '';
                
                // Show processing status
                this.showStatus('메시지 처리 중...');
                
                // Send to WebSocket
                this.websocket.send(JSON.stringify({
                    message: message
                }));
            }
            
            handleMessage(data) {
                console.log('Received message:', data);
                
                switch (data.type) {
                    case 'system':
                        this.displayMessage('system', data.content);
                        break;
                    case 'claude_response':
                        this.displayMessage('claude', data.content);
                        this.hideStatus();
                        break;
                    default:
                        console.warn('Unknown message type:', data.type);
                }
            }
            
            displayMessage(role, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'flex mb-4';
                
                if (role === 'user') {
                    messageDiv.innerHTML = `
                        <div class="flex-1"></div>
                        <div class="max-w-md">
                            <div class="message-user text-white rounded-lg px-4 py-3 shadow-md">
                                <p class="text-sm font-medium mb-1">사용자</p>
                                <p class="whitespace-pre-wrap">${this.escapeHtml(content)}</p>
                            </div>
                            <p class="text-xs text-gray-500 mt-1 text-right">${this.formatTime(new Date())}</p>
                        </div>
                    `;
                } else if (role === 'claude') {
                    messageDiv.innerHTML = `
                        <div class="max-w-3xl">
                            <div class="message-claude text-white rounded-lg px-4 py-3 shadow-md">
                                <p class="text-sm font-medium mb-1">Claude</p>
                                <div class="whitespace-pre-wrap">${this.formatClaudeResponse(content)}</div>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">${this.formatTime(new Date())}</p>
                        </div>
                        <div class="flex-1"></div>
                    `;
                } else if (role === 'system') {
                    messageDiv.innerHTML = `
                        <div class="w-full">
                            <div class="message-system text-white rounded-lg px-4 py-3 shadow-md text-center max-w-md mx-auto">
                                <p class="text-sm">${this.escapeHtml(content)}</p>
                            </div>
                        </div>
                    `;
                }
                
                this.chatArea.appendChild(messageDiv);
                this.scrollToBottom();
            }
            
            formatClaudeResponse(content) {
                // Simple formatting for Claude's response
                return this.escapeHtml(content)
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/`(.*?)`/g, '<code class="bg-white bg-opacity-20 px-1 rounded">$1</code>');
            }
            
            escapeHtml(text) {
                return Utils.escapeHtml(text);
            }
            
            formatTime(date) {
                return Utils.formatTime(date);
            }
            
            showStatus(message) {
                this.statusMessage.textContent = message;
                this.statusBar.classList.remove('hidden');
            }
            
            hideStatus() {
                this.statusBar.classList.add('hidden');
            }
            
            scrollToBottom() {
                this.chatArea.scrollTop = this.chatArea.scrollHeight;
            }
        }
        
        // Initialize the application when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            new AIAgentWorkspace();
        });
    </script>
</body>
</html>